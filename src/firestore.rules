rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Default deny all
    match /{document=**} {
      allow read, write: if false;
    }
    
    // Users can read any profile, but only write to their own.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow update, delete: if request.auth.uid == userId;
      // Allow users to be created with a new account
      allow create: if request.auth.uid == userId;
    }
    
    // Rules for the usernames collection for checking uniqueness
    match /usernames/{username} {
        allow read: if request.auth != null;
        allow create: if request.auth.uid == request.resource.data.uid;
        allow delete: if request.auth.uid == resource.data.uid;
    }

    // Admins can read/write to the app_config collection
    match /app_config/{configId} {
        allow read, write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Rules for chat rooms and messages
    match /chats/{chatId} {
      // Allow read/update if the user is a participant in the chat
      allow read, update: if request.auth.uid in resource.data.participantIds;
      // Allow creation if the user is one of the participants
      allow create: if request.auth.uid in request.resource.data.participantIds;
      
      // Rules for messages within a chat
      match /messages/{messageId} {
        // Allow reads if user is a participant
        allow read: if get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds[0] == request.auth.uid || 
                     get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds[1] == request.auth.uid;
        // Allow writes if user is the sender and a participant
        allow create: if (get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds[0] == request.auth.uid || 
                        get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds[1] == request.auth.uid) &&
                       request.resource.data.senderId == request.auth.uid;
      }
      
      // Rules for transactions within a user's doc (subcollection of users)
      // This needs to be under a user match, so moving it under /users/{userId}
    }
    
    // Rules for user subcollections (like transactions)
    match /users/{userId}/transactions/{transactionId} {
        allow read, create: if request.auth.uid == userId;
    }

    // Friend requests can be read by either sender or receiver
    // They can only be created by the sender.
    // They can only be deleted by the receiver (when accepting/rejecting)
    match /friend_requests/{requestId} {
      allow read: if request.auth.uid == resource.data.senderId || request.auth.uid == resource.data.receiverId;
      allow create: if request.auth.uid == request.resource.data.senderId;
      allow delete: if request.auth.uid == resource.data.receiverId;
      allow update: if false; // No updates allowed, only create/delete
    }

    // Connections can be read by either participant
    match /connections/{connectionId} {
      allow read: if request.auth.uid in resource.data.participants;
      allow create: if request.auth.uid in request.resource.data.participants;
      allow delete: if false; // Do not allow clients to delete connections
    }
  }
}
